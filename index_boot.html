<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap-Test</title>
	
	<!-- D3 -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	
	<!-- App -->
    <link href="css/app.css" rel="stylesheet">
	
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	
	<!-- Mapbox -->
	<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css' rel='stylesheet' />
	
	<!-- DVF -->
	<script type="text/javascript" src="js/leaflet-dvf.markers.min.js"></script>
	<link href="css/dvf.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
	
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	  <div class="container-fluid">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
		  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
			<span class="sr-only">Toggle navigation</span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		  </button>
		  <a class="navbar-brand" href="index_boot.html">SmartEnergyMap</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
		  <ul class="nav navbar-nav">
			<li class="active"><a href="#"><span class="glyphicon glyphicon-picture"></span> Map </a></li>
			<li><a href="#"><span class="glyphicon glyphicon-info-sign"></span> About </a></li>
			<li><img id="navLogo" src="img/logo2.png"></li>
		  </ul>
		</div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>
	<!-- The Map -->
	<div id="map"></div>
	<div id='map1'></div>
	<div id='map2'></div>
	<!-- Animationsknopf hinzufügen
	<div>
		<img id="animationButton" src="img/animationButton.png">
		<input 	name="animationButton"
					type="image"
					value="Start Animation"	
					src="img/animationButton.png
			/>
	</div>
	<!-- Add a div for the button onclick="startAnimation()" -->
		<div id="animationButton">
			<input 	name="animationButton"
					type="button"
					value="Start Animation"	
					onclick="startAnimation()"
			/>
		</div>
		<!--
		<div id="timeControl"> 
			<span class="glyphicon glyphicon-play"></span>
		</div>
		-->
	<!-- Animationsknopf hinzufügen-->
	<!--<div><img id="logo" src="img/logo2.png"></div>-->
	<div id="titleLocation">Location-View</div>
	<div id="titleEnergy">Energy-View</div>
	<div id="currentTime"></div>
	<!--
	<div id="locationLegend"><img id="locationLegend" src="img/LegendInnoZLocation.png"></div>
	-->
	<div id='legend' style='display:none;'>
		<table>
		<!--
		<tr>
			<td> 
				
				<span class="glyphicon glyphicon-play"></span> 
				<span class="glyphicon glyphicon-pause"></span>
				<span class="glyphicon glyphicon-stop"></span>
				<span class="glyphicon glyphicon-refresh"></span>
			</td>
		</tr>
		-->
		<tr>
			<td> 
				<div class="legendText"> Erzeuger </div>
			</td>
			<td> 
				<div id="circle"></div>
			</td>
		</tr>
		<tr>
			<td> Speicher </td>
			<td> <div id="squere"></div> </td>
		</tr>
		<tr>
			<td> Verbraucher </td>
			<td> <div id="triangle"></div> </td>
		</tr>
		<tr>
			<td> 
				<div class="legendText"> Steuerelemente </div> 
			</td>
			<td> 
				<div id="hexTop"></div>
				<div id="hexMid"></div>
				<div id="hexBot"></div>
			</td>
		</tr>
		<tr>
			<td> <span class="glyphicon glyphicon-flash"></span> Strom </td>
			<td> <div id="electricity"></div> </td>
		</tr>
		<tr>
			<td> <span class="glyphicon glyphicon-fire"></span> Wärme </td>
			<td> <div id="heat"></div> </td>
		</tr>
		<tr>
			<td> <span class="glyphicon glyphicon-tint"></span> Gas </td>
			<td> <div id="gas"></div></td>
		</tr>
		
		</table>		
	</div>
	
	<!-- Geodaten laden-->
	<script src='data/msgPoints.js'></script>
	<script src='data/msgLines.js'></script>
	<script src="data/line.js">//do we need this? -> yes</script>
	
	<!-- JavaScript-Code -->
	<script>
		//### Laden der aktuellen Daten ###
		var json = (function() {
			var json = null;
			$.ajax({
				'async': false,
				'global': false,
				'url': "data/data_producer.json",
				'dataType': "json",
				'success': function (data) {
					json = data;
				}
			});
			console.log("Daten werden geladen...");
			return json;
		})();
		console.log("Daten wurden geladen!");
		console.log(json);
		
		var moverValue = json[0].Mover;
		console.log(moverValue);
		
		//L.mapbox.accessToken = '<your access token here>';
		
		//### Inizialisierung der Karte ###
		var map1 = L.mapbox.map('map1', 'examples.map-b70jh5xu')
			.setView([52.481707,13.356576], 17);
		var map2 = L.mapbox.map('map2', 'examples.map-cnkhv76j', { zoomControl:false })
			.setView([52.481707,13.356576], 17);
			
		map2.legendControl.addLegend(document.getElementById('legend').innerHTML);
		
		//Quellcode für Syncronisation stamt von Mapbox --> https://www.mapbox.com/mapbox.js/example/v1.0.0/sync-layer-movement-antipode/
		// when either map finishes moving, trigger an update on the other one.
		map1.on('moveend', follow).on('zoomend', follow);
		map2.on('moveend', follow).on('zoomend', follow);

		// quiet is a cheap and dirty way of avoiding a problem in which one map
		// syncing to another leads to the other map syncing to it, and so on
		// ad infinitum. this says that while we are calling sync, do not try to 
		// loop again and sync other maps
		var quiet = false;
		function follow(e) {
			if (quiet) return;
			quiet = true;
			if (e.target === map1) sync(map2, e);
			if (e.target === map2) sync(map1, e);
			quiet = false;
		}

		// sync simply steals the settings from the moved map (e.target)
		// and applies them to the other map.
		function sync(map, e) {
			map.setView(e.target.getCenter(), e.target.getZoom(), {
				animate: false,
				reset: true
			});
		}
		
		//Maßstab hinzufügen
		L.control.scale().addTo(map1);
		
		//### Punkte und Linien einbinden ###
		var msgPoints = msgPoints; 
		
		//### Hinzufügen von individuellen Markern ###
		// dafür sollte eine Funktion erstellt werden!
		
		//### Location-View ###
			//große Symbole
			var LeafIcon = L.Icon.extend({
				options: {
					iconSize:     [35, 35],
					popupAnchor:  [0, -10]
				}
			});
			//kleine Symbole
			var LeafIconLittle = L.Icon.extend({
				options: {
					iconSize:     [30, 28],
					popupAnchor:  [0, -10]
				}
			});

			var batterieIcon = new LeafIcon({iconUrl: 'img/msg_batteryFull.png'}),
				windIcon = new LeafIcon({iconUrl: 'img/msg_windFull.png'}),
				chargingIcon = new LeafIcon({iconUrl: 'img/msg_chargeFull.png'}),
				photoIcon = new LeafIcon({iconUrl: 'img/msg_solarFull.png'}),
				brainIcon = new LeafIcon({iconUrl: 'img/msg_brainFull.png'}),
				netIcon = new LeafIconLittle({iconUrl: 'img/netconnectionT.png'});
			
			//Marker zu den Karten hinzufügen
			
			for (var i = 0; i < msgPoints.features.length; i++) {
				var lon = msgPoints.features[i].geometry.coordinates[1];
				var lat = msgPoints.features[i].geometry.coordinates[0];
				var type = msgPoints.features[i].properties.type;
				switch (msgPoints.features[i].properties.type) {
					case "Windkraftanlage" : 
						L.marker([ lon, lat], {icon: windIcon}).bindPopup("---------------------------------------------" + "</br>" + type + "</br>" + "aktuelle Produktion: " + json[0].WEA_Haus1 + " kW").addTo(map1),
						L.marker([ lon, lat], {icon: windIcon}).addTo(map2);
						break;
					case "Photovoltaikanlage" : 
						L.marker([ lon, lat], {icon: photoIcon}).bindPopup("<img src='img/popup_small.png'/>").addTo(map1);
						L.marker([ lon, lat], {icon: photoIcon}).addTo(map2);
						break;
					case "Batterie" : 
						L.marker([ lon, lat], {icon: batterieIcon}).bindPopup("---------------------------------------------" + "</br>" +type + "</br>" + "aktuelle Produktion: " + json[0].Mover + " kW").addTo(map1);
						L.marker([ lon, lat], {icon: batterieIcon}).addTo(map2);
						break;
					case "Steuerzentrale" : 
						L.marker([ lon, lat], {icon: brainIcon}).bindPopup("---------------------------------------------" + "</br>" +type).addTo(map1);
						L.marker([ lon, lat], {icon: brainIcon}).addTo(map2);
						break;
					case "Netzverbindung" : 
						L.marker([ lon, lat], {icon: netIcon}).bindPopup("---------------------------------------------" + "</br>" +type).addTo(map1);
						L.marker([ lon, lat], {icon: netIcon}).addTo(map2);
						break;
					default: console.log("Einige Elemente werden nicht dargestelt!");
						break;
				}
			};
			
			/*
			//http://stackoverflow.com/questions/12661685/2-different-leaflet-popup-styles
			marker.on('mouseover', function() {
				marker.bindPopup('<b>Hello world</b>',{className: 'mouseover-popup'});
				marker.openPopup();
			})

			marker.on('click', function() {
				marker.bindPopup('<b>Hello world</b>',{className: 'click-popup'});
				marker.openPopup();
			})
			*/
			
		//### Energy-View ###	
		//### RadialMeterMarker ###
		var minHue = 120;
		var maxHue = 0; 
		//var testLon = msgPoints.features[0].geometry.coordinates[0];
		//console.log(testLon);
		//var testLat = msgPoints.features[0].geometry.coordinates[1];
		//console.log(testLat);
		//var markerLat = 52.480688658255012;
		//var markerLon = 13.354568528677662;
		
		var windNorm = 500;
		var solarNorm = 50;
		
		for (var i = 0; i < msgPoints.features.length; i++) {
			if (msgPoints.features[i].properties.type === "Windkraftanlage") {
				console.log("Wind");
				addRadialMarker(msgPoints.features[i].geometry.coordinates[1], msgPoints.features[i].geometry.coordinates[0], json[0].WEA_Haus1, windNorm);
			}
		};
		
		for (var i = 0; i < msgPoints.features.length; i++) {
			if (msgPoints.features[i].properties.type === "Photovoltaikanlage") {
				console.log("Solar");
				addRadialMarker(msgPoints.features[i].geometry.coordinates[1], msgPoints.features[i].geometry.coordinates[0], json[0].Mover, solarNorm);
			}
		};
		//addRadialMarker(markerLat, markerLon, moverValue);
		//addRadialMarker(msgPoints.features[1].geometry.coordinates[1], msgPoints.features[1].geometry.coordinates[0], moverValue);

		function addRadialMarker (yCoord, xCoord, eValue, norm) {
			var radialMarker = new L.RadialMeterMarker(new L.LatLng(yCoord, xCoord), {
			   data: {
					'Capasity': eValue * norm
				},
				chartOptions: {
					'Capasity': {
						displayName: 'Auslastung',
						displayText: function (value) {
						return value.toFixed(1);
						},
						color: 'hsl(190,50%,45%)',
						fillColor: 'hsl(190,50%,45%)',
						maxValue: 100,
						minValue: 0
					}
				},
				displayOptions: {
					'Capasity': {
						color: 'hsl(190,50%,45%)',
						fillColor: 'hsl(190,50%,45%)',
					}
				},
				fillOpacity: 0.6,
				opacity: 1,
				weight: 0.5,
				radius: 30,
				barThickness: 15,
				maxDegrees: 360,
				rotation: 270,
				numSegments: 1
			});

			map2.addLayer(radialMarker);
			
		}
		
		
		//### add Lines with Leaflet-Funktion
		//Linien befinden sich später in der D3-Ebene
		var lines = msgLines;
		
		var myStyle = {
			"color": "#0099CC",
			"weight": 3,
			"opacity": 0.65
		};
		
		var ELine = L.geoJson(lines, {style: myStyle}).addTo(map1);
		
		ELine.on('click', function() {
				ELine.bindPopup(
                    "Stromleitung"
                );
			})
		
		/*
		var animation = document.getElementById('animationButton');
		animation.onclick = function startAnimation() {
			alert("Diese Funktion wird gerade implementiert. Die Energieströme werden bald fließen!");
		};
		*/
		//initialize the variable myPath
		var myPath;
		//initialize the animationFunction und access the button over the DOM
		//example --> http://jsfiddle.net/pFYUM/1/
		var animationFunction = document.getElementById('animationButton');
			
	
		/*### add a d3 svg/g-element to the map ###*/
		// Initialize the SVG layer
		map2._initPathRoot()    
		//pick up the SVG from the map object
		var svg = d3.select("#map2").select("svg"),
		g = svg.append("g")
				.attr("class", "route");
				
		/*### add lines ###*/
		// Add a second SVG element to Leaflet’s overlay pane to make sure that they fit together
		var svg2 = d3.select(map2.getPanes().overlayPane).append("svg2"),
			// the g element make sure that the D3- and Leaflet-Layer has the same point of reference
			g2 = svg2.append("g2").attr("class", "leaflet-zoom-hide");
		
		//load the json-data	
		//d3.json("", function(geoShape) {
			// create a d3.geo.path to convert GeoJSON to SVG
			//transform corectly the latitude/longitude coordinates to screen coordinates
			var transform = d3.geo.transform({point: projectPoint}),
			path = d3.geo.path().projection(transform);
				
			// create path elements for each of the features and append it to our g group
			d3_features = g.selectAll("path")
				.data(msgLines.features)
				.enter().append("path").attr("d", path)
				.attr('id', msgLines.features[0].properties.id)
				.style("stroke", "white")
				//.style("stroke-width", 9)
				.style("fill", "none");
			
			// make sure that the d3 element changes when we zoom or pan 
			map2.on("viewreset", reset);
				
			reset();
				
		// fit the SVG element to leaflet's map layer -> reset the d3-layer when the extant changes
			function reset() {
				//take the current coordinates of the topLeft and buttomRight corners
				bounds = path.bounds(msgLines);
				var topLeft = bounds[0],
					bottomRight = bounds[1];
					// apply the coordniates to the svg
					svg2.attr("width", bottomRight[0] - topLeft[0])
						.attr("height", bottomRight[1] - topLeft[1])
						.style("left", topLeft[0] + "px")
						.style("top", topLeft[1] + "px");
					g2.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

		// initialize the path data
			d3_features.attr("d", path)
						.style("fill-opacity", 0.7)
						.attr('fill','blue');
			}
		
		// Use Leaflet to implement a D3 geometric transformation.
		// take the latitude and longitudes and transform them into screen coordinates
			function projectPoint(x, y) {
				var point = map2.latLngToLayerPoint(new L.LatLng(y, x));
				this.stream.point(point.x, point.y);
			}
			
		//### animate the path --> use the function###
		//original code from here: http://jsfiddle.net/5m35J/6/
		//animationFunction.onclick = startAnimation;
			
		//});
	
	//### animate the path --> this is the function###
	//original code from here: http://jsfiddle.net/5m35J/6/
	function startAnimation() {
		
		// declare some variables
		var vis, xy, duration, offset, origin_x, origin_y, len, circle, circle2, circle3;

		// select the correct layer
		var vis = d3.select(".leaflet-overlay-pane")
			.data(line.features)
			.enter();
		console.log(vis);
		//var countLength = msgLines.length;
		//console.log(countLength);
		
		//for loop for each feature in the jsonfile
		var counter = 0;
		for (feature in msgLines.features) {
		console.log("JUHUUUU!");
		
		var group = svg.append("svg:g");
		
		//take the path from the geojson
		var targetPath = d3.selectAll('.route')[0][0];
		console.log(targetPath);
		var pathNode = d3.select(targetPath).selectAll('path').node();
		console.log("pathNode");
		console.log(pathNode);
		var pathLength = pathNode.getTotalLength();
		console.log(pathLength);
		
		//append the circle to the first vertex of the geojson
		circle = group.append("circle")
			.attr({
			r: 5,
			fill: '#00BFFF',
			transform: function () {
				var p = pathNode.getPointAtLength(0)
				return "translate(" + [p.x, p.y] + ")";
			}
		});
		console.log(circle);
		
		circle2 = group.append("circle")
			.attr({
			r: 5,
			fill: '#00BFFF',
			transform: function () {
				var p = pathNode.getPointAtLength(0)
				return "translate(" + [p.x, p.y] + ")";
			}
		});
		circle3 = group.append("circle")
			.attr({
			r: 5,
			fill: '#00BFFF',
			transform: function () {
				var p = pathNode.getPointAtLength(0)
				return "translate(" + [p.x, p.y] + ")";
			}
		});

		// move the circle along the path
		duration = 1000;
		circle.transition()
			.duration(duration)
				.delay(750)
			.ease("linear")
			.attrTween("transform", function (d, i) {
			return function (t) {
				var p = pathNode.getPointAtLength(pathLength*t);
				return "translate(" + [p.x, p.y] + ")";
			}
		});
		circle2.transition()
			.duration(duration)
				.delay(1000)
			.ease("linear")
			.attrTween("transform", function (d, i) {
			return function (t) {
				var p = pathNode.getPointAtLength(pathLength*t);
				return "translate(" + [p.x, p.y] + ")";
			}
		});
		
		circle3.transition()
			.duration(duration)
				.delay(1250)
			.ease("linear")
			.attrTween("transform", function (d, i) {
			return function (t) {
				var p = pathNode.getPointAtLength(pathLength*t);
				return "translate(" + [p.x, p.y] + ")";
			}
		});
		
		counter++;
		};
	};
		//### Aktuelle Zeit anzeigen ###
		//Code-Example: http://jsfiddle.net/cse_tushar/fKKSb/
		function checkTime(i) {
			if (i < 10) {
				i = "0" + i;
			}
			return i;
		}

		function startTime() {
			var today = new Date();
			var h = today.getHours();
			var m = today.getMinutes();
			var s = today.getSeconds();
			// add a zero in front of numbers<10
			m = checkTime(m);
			s = checkTime(s);
			document.getElementById('currentTime').innerHTML = "aktuelle Zeit: " + h + ":" + m + ":" + s;
			t = setTimeout(function () {
				startTime()
			}, 500);
		}
		startTime();
		
		</script>
  </body>
</html>