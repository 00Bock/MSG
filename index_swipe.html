<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>SwipeMap</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<style>
	  body { margin:0; padding:0; }
	  #map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
</head>
<body>
	<!-- Daten einladen-->
	<script src='data/msgPoints.js'></script>
	<script src='data/msgLines.js'></script>
	<!-- Styles definieren-->
	<style>
	.range {
	  margin-top: 10px;
		-webkit-appearance: none !important;
		background:rgba(255,255,255,0.7);
		height:30px;
		width: 99%;
		position: absolute;
	  }
	.leaflet-top .leaflet-control-zoom {
	  top:40px;
	  }
	.legend label,
	.legend span {
	  display:block;
	  float:left;
	  height:15px;
	  width:20%;
	  text-align:center;
	  font-size:9px;
	  color:#808080;
	  }
	
	</style>
	<!-- Legende hinzufügen-->
	<div id='legend' style='display:none;'>
	  <strong>Energieströme im Micro-Smart-Grid</strong>
	  <p style="font-size:1 em">
		<span>Kreisgröße entspricht Energiemenge</span>
	  </p>
	  <p><img src="img/triangle.png" width="20" height="20" alt="triangle"/></p> <!-- funktioniert nicht???-->
	  <p style="font-size:1 em">Dreieck = Erzeuger</p>
	  <p style="font-size:1 em">Viereck = Speicher</p>
	  <p style="font-size:1 em">Kreis = Verbraucher</p>
	  <p style="font-size:1 em"> * = 1mW </p>
	  <p style="font-size:1 em"> ** = 2mW </p>
	  <p style="font-size:1 em"> *** = 3mW </p>
	  <small>Source: <a href="#link to source">Name of source</a></small>
	</div>
	<!-- Karte hinzufügen-->
	<div id='map'></div>
	<input id='range' class='range' type='range' min='0' max='1.0' step='any' />

	<script>
	//### Karte mit Swipefunktion erstellen ###
	var map = L.mapbox.map('map', null, {minZoom:18});
	L.mapbox.tileLayer('examples.map-cnkhv76j').addTo(map); //mapbox-id for black map

	var overlay = L.mapbox.tileLayer('examples.map-b70jh5xu').addTo(map); //mapbox-id for simple map
	var range = document.getElementById('range');

	function clip() {
	  var nw = map.containerPointToLayerPoint([0, 0]),
		  se = map.containerPointToLayerPoint(map.getSize()),
		  clipX = nw.x + (se.x - nw.x) * range.value;

	  overlay.getContainer().style.clip = 'rect(' + [nw.y, clipX, se.y, nw.x].join('px,') + 'px)';
	}

	range['oninput' in range ? 'oninput' : 'onchange'] = clip;
	map.on('move', clip);
	map.setView([52.481707,13.356576], 18);

	clip();

	//### Legend einfügen ###
	map.legendControl.addLegend(document.getElementById('legend').innerHTML);

	//### Punkte einbinden ###
	var msgPoints = msgPoints; //schreibt js-Inhalt in Variable

	//Punkte hinzufügen --> alte Punkte
	//map.featureLayer.setGeoJSON(msgPoints); // add points with style

	//Popup hinzufügen --> vertragt sich nicht mit dem style und überlagert sich daher mit den bereits eingefügten Punkten
	/*
	var myLayer = L.geoJson(msgPoints, {
		// style: function (feature) {
		//     return feature.properties.style;
		// },
		 onEachFeature: function (feature, layer) {
			 layer.bindPopup(feature.properties.type + '</br>' + 
								'Energiewert: ' + feature.properties.value);
		 }
	 });

	 
	//myLayer.addData(msgPoints);
	myLayer.addTo(map);
	*/
	
	//### hinzufügen von individuellen Markern ###
	// dafür sollte eine Funktion erstellt werden!
		var LeafIcon = L.Icon.extend({
			options: {
				//shadowUrl: '../docs/images/leaf-shadow.png',
				iconSize:     [70, 70],
				//shadowSize:   [50, 64],
				//iconAnchor:   [22, 94],
				//shadowAnchor: [4, 62],
				popupAnchor:  [0, -10]
			}
		});

		var batterieIcon = new LeafIcon({iconUrl: 'img/battery_ebattery_w.png'}),
			windIcon = new LeafIcon({iconUrl: 'img/producer_wind_w.png'});
			chargingIcon = new LeafIcon({iconUrl: 'img/battery_ecar_w.png'});
			photoIcon = new LeafIcon({iconUrl: 'img/producer_solar_w.png'});

		L.marker([52.48243899971542, 13.35747111893229], {icon: batterieIcon}).bindPopup("<h4>I am a battery.</h4> <p> Capacity: 80% </p>").addTo(map);
		//L.marker([52.48243899971542, 13.35747111893229], {icon: batterieIcon}).bindPopup("I am a batterie. <div class="popup_batterie_div"></div>").addTo(map);
		L.marker([52.480688658255012 , 13.354568528677662], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		L.marker([52.480911923161734, 13.355110029627905], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		L.marker([52.481457 , 13.355791], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		L.marker([52.48159684369503, 13.355837930668985], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		L.marker([52.481227, 13.356873], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		L.marker([52.481662, 13.357115], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		//L.marker([52.48167184015486, 13.357115010925135], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		//L.marker([52.481797374733404, 13.356779623859563], {icon: chargingIcon}).bindPopup("I am a charging station.").addTo(map);
		//L.marker([52.482247714873587, 13.357158553524592], {icon: windIcon}).bindPopup("I am a wind wheel.").addTo(map);
		L.marker([52.482262, 13.357565], {icon: photoIcon}).bindPopup("I am a solar panel.").addTo(map);
		L.marker([52.482455631243511, 13.357434101623429], {icon: photoIcon}).bindPopup("I am a solar mover.").addTo(map);
		L.marker([52.481356, 13.355660], {icon: photoIcon}).bindPopup("I am a solar panel.").addTo(map);
		//L.marker([52.482455631243511, 13.357434101623429], {icon: photoIcon}).bindPopup("I am a solar panel.").addTo(map);
		//L.marker([52.482058471303993, 13.357288699302121], {icon: photoIcon}).bindPopup("I am a wind wheel.").addTo(map);
		//L.marker([51.495, -0.083], {icon: redIcon}).bindPopup("I am a red leaf.").addTo(map);
		//L.marker([51.49, -0.1], {icon: orangeIcon}).bindPopup("I am an orange leaf.").addTo(map);
		//var batteriediv = document.getElementsByClassName( 'popup_batterie_div' )[0];
		//batteriediv.innerHTML = 'I am the div';
	
	//### add Lines with Leaflet-Funktion
	//Linien befinden sich später in der D3-Ebene
	var lines = msgLines;
	L.geoJson(lines).addTo(map); 
	
	/*
	//D3-Teil startet --> muss noch angepasst werden
	//### add circles ###
		//add D3 circles
		// Initialize the SVG layer
		map._initPathRoot()    

		//pick up the SVG from the map object
		var svg = d3.select("#map").select("svg"),
		g = svg.append("g");
		
		d3.json("data/circlesMSG.json", function(collection) {
			// Add a LatLng object to each item in the dataset 
			collection.objects.forEach(function(d) {
				d.LatLng = new L.LatLng(d.circle.coordinates[0],
										d.circle.coordinates[1])
			})
			//place the circles based on the coordinates of each of our objects
			var feature = g.selectAll("circle")
				.data(collection.objects)
				.enter().append("circle")
				.style("stroke", "black")  
				.style("opacity", .6) 
				.style("fill", "#00A2FF")
				.attr("r", 20);  //here we have to add later the value
			// reset-function for a fixed size
			map.on("viewreset", update);
			update();

			function update() {
				feature.attr("transform", 
				function(d) { 
					return "translate("+ 
						map.latLngToLayerPoint(d.LatLng).x +","+ 
						map.latLngToLayerPoint(d.LatLng).y +")";
					}
				)
			}
		});
		*/
		/*
		//### add lines ###
		// Add a second SVG element to Leaflet’s overlay pane to make sure that they fit together
		var svg2 = d3.select(map.getPanes().overlayPane).append("svg2"),
			// the g element make sure that the D3- and Leaflet-Layer has the same point of reference
			g2 = svg2.append("g2").attr("class", "leaflet-zoom-hide");
			
		d3.json("data/line.json", function(geoShape) {
			
			// create a d3.geo.path to convert GeoJSON to SVG
			//transform corectly the latitude/longitude coordinates to screen coordinates
			var transform = d3.geo.transform({point: projectPoint}),
			path = d3.geo.path().projection(transform);
				
			// create path elements for each of the features and append it to our g group
			d3_features = g.selectAll("path")
				.attr("class", "route") //inserted for transition -> not working
				.data(geoShape.features)
				.enter().append("path")
				.style("stroke", "white")
				.style("fill", "none");
			
			// make sure that the d3 element changes when we zoom or pan 
			map.on("viewreset", reset);
				
			reset();
				
		// fit the SVG element to leaflet's map layer -> reset the d3-layer when the extant changes
			function reset() {
				//take the current coordinates of the topLeft and buttomRight corners
				bounds = path.bounds(geoShape);
				var topLeft = bounds[0],
					bottomRight = bounds[1];
					// apply the coordniates to the svg
					svg2 .attr("width", bottomRight[0] - topLeft[0])
						.attr("height", bottomRight[1] - topLeft[1])
						.style("left", topLeft[0] + "px")
						.style("top", topLeft[1] + "px");
				g2 .attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

		// initialize the path data
			d3_features.attr("d", path)
						.style("fill-opacity", 0.7)
						.attr('fill','blue');
			}
		
		
		// Use Leaflet to implement a D3 geometric transformation.
		// take the latitude and longitudes and transform them into screen coordinates
			function projectPoint(x, y) {
				var point = map.latLngToLayerPoint(new L.LatLng(y, x));
				this.stream.point(point.x, point.y);
			}
		});
		*/
	</script>
</body>
</html>